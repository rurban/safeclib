<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>safec: Overview of various libc&#39;s regarding the secure C11 extensions</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">safec<span id="projectnumber">&#160;3.9</span>
   </div>
   <div id="projectbrief">Safe C Library - ISO TR24731 Bounds Checking Interface</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d6/d31/md_doc_2libc-overview.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Overview of various libc's regarding the secure C11 extensions</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8"></a></p>
<p>C11 defined the optional secure extensions to be demanded by <code>__STDC_WANT_LIB_EXT1__</code>.</p>
<p>From the following tested libc implementations:</p>
<ul>
<li>glibc</li>
<li>musl</li>
<li>FreeBSD and DragonFly libc</li>
<li>FreeBSD-derived darwin libc</li>
<li>OpenBSD libc</li>
<li>newlib (Cygwin)</li>
<li>dietlibc</li>
<li>uClibc</li>
<li>minilibc</li>
<li>Microsoft Windows under wine</li>
<li>Microsoft Windows msvcrt and ulibc w/ secure API</li>
<li>Open Watcom</li>
<li>Android Bionic</li>
<li>Huawei securec</li>
<li>Embarcadero C++ libc</li>
<li>slibc</li>
</ul>
<p>only the last 6 implement the secure C11 extensions:</p>
<ul>
<li>Microsoft Windows</li>
<li>Open Watcom since 1.5</li>
<li>Android Bionic w/ stlport</li>
<li>Huawei securec</li>
<li>Embarcadero C++ libc</li>
<li>slibc</li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
General quirks</h1>
<p>Generally most libc's use a 4 byte wchar_t (which resembles UTF-32), but windows/cygwin/solaris/aix use 2-byte (UTF-16), therefore they need to support surrogate pairs.</p>
<p>The wide sprintf variants do not allow a NULL buffer argument to return the size of the resulting buffer. If the initial buffer is too small, you need to realloc and redo.</p>
<p>There's still no locale-independent utf8 support, not even in C11 with its new <code>u8""</code> type.</p>
<p>Many wchar and mb conversions and searches are locale-dependent, hence unusable for utf8.</p>
<p>Nobody implements a proper wchar case-conversion, foldcase and normalization API. ICU or libunistring are way too heavy for this simple problem. There's only utf8proc for utf8 encoded strings (now with julia).</p>
<p>See also <a href="http://crashcourse.housegordon.org/coreutils-multibyte-support.html">http://crashcourse.housegordon.org/coreutils-multibyte-support.html</a></p>
<p>None of the other libc's (and neither most crypto libraries) provide a secure memory barrier for memset/memzero/memset_s/explicit_bzero/SecureZeroMemory/..., they only provide a compiler barrier against false compiler optimizations. They don't reliably sync memory stores with possibly re-ordered loads by modern out-of-order CPU's. Only the linux kernel and safeclib do so.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Unrelated to Annex K, but security related</h1>
<p>C11 introduced unsafe unicode identifiers, with identifiers becaming unidentifiable, without any <b>-Whomo-glyph</b> standardization or following the <a href="http://www.unicode.org/reports/tr39/">UTR 39 Security guidelines</a>. See my <a href="https://rurban.github.io/libu8ident/">libu8ident</a> which checks for these, and <a href="https://rurban.github.io/libu8ident/doc/D2528R1.html">D2528R1 - C++ Identifier Security using Unicode Standard Annex 39</a></p>
<h1><a class="anchor" id="autotoc_md11"></a>
C11 Annex K/safec caveats</h1>
<ul>
<li><p class="startli"><code>tmpnam_s</code>:</p>
<p class="startli">Is considered unsafe. <code>tmpnam_s</code> and <code>tmpnam</code> are racy.</p>
</li>
<li><p class="startli"><code>sprintf_s</code> and <code>vsprintf_s</code> retval on errors.</p>
<p class="startli">They were revised by the author from Microsoft in <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1141.pdf">n1141</a> to return <code>0</code> on most errors (only <code>-1</code> on encoding errors), to allow the often used <code>count += sprintf(buf + count, format_string, args);</code> when no encoding errors could occur, ignoring <code>retval &lt; 0</code> checks. Lateron Microsoft and all other implementors (e.g. Embacadero, safeclib) revised this decision to be consistent, to return <code>-1</code> on all errors, just the standard still contains the <b>n1141</b> revision.</p>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
Microsoft Windows/MINGW_HAS_SECURE_API</h2>
<ul>
<li><code>fopen_s</code>, <code>freopen_s</code> deviate in the API: restrict is missing.</li>
<li><code>strtok_s</code>, <code>wcstok_s</code>,<code>vsnprintf_s</code> miss the dmax argument.</li>
<li><code>vsnprintf_s</code> adds a maxarg argument.</li>
<li><code>vswprintf</code> adds a maxarg argument on w32. (with <code>__STRICT_ANSI__</code> undefined)</li>
<li>no <code>strnlen</code> on mingw32.</li>
<li>no <code>errno_t</code> return type for <code>qsort_s</code>, only <code>void</code>.</li>
<li>reversed argument order for <code>localtime_s</code> and <code>gmtime_s</code>.</li>
<li>older mingw versions have <code>wchar.h</code> with only 2 functions: <code>wcscmp</code>, <code>wcslen</code></li>
<li>no <code>RSIZE_MAX</code></li>
<li><code>memmove_s</code> does not clear dest with ERANGE when <code>count &gt; dmax</code> and EINVAL when src is a NULL pointer.</li>
<li><code>vsprintf_s</code>, <code>sprintf_s</code> return <code>-1</code> on all errors, not just encoding errors. (Wrong standard)</li>
<li>With <code>wcsrtombs</code> (used by <code>wcsrtomb_s</code>) the <code>*retval</code> result includes the terminating zero, i.e. the result is <code>+1</code> from the spec.</li>
<li><code>getenv_s</code> returns in len the size of the env buffer, not the len, as described in the standard (<a href="https://en.cppreference.com/w/c/program/getenv">https://en.cppreference.com/w/c/program/getenv</a>). The Microsoft size is len + 1. Their usage example is also wrong: <a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getenv-s-wgetenv-s?view=msvc-170">https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getenv-s-wgetenv-s?view=msvc-170</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
safeclib</h2>
<ul>
<li>safeclib does not check optional NULL parameters to the vararg <code>scanf_s</code> and <code>printf_s</code> functions. This would need tighter integration into the upstream libc. Similarily the 2nd size parameter for <code>s</code>, <code>c</code> and <code>%[</code> is not implemented.</li>
<li>safeclib <code>fgets_s</code> permits temporary writes of <code>dmax+1</code> characters into dest.</li>
<li><code>vsprintf_s</code>, <code>sprintf_s</code> return <code>-1</code> on all errors, not just encoding errors. (Wrong standard)</li>
</ul>
<h2><a class="anchor" id="autotoc_md14"></a>
Android FORTIFY and _STLP_USE_SAFE_STRING_FUNCTIONS</h2>
<p>Not yet tested. Hard to find as open source. Apparently once implemented as part of the <em>stlport</em> library, but unused and I cannot find it in Bionic (orea), which is mostly an improved FreeBSD libc. <em>stlport</em> had a portable rewrite of the secure Windows API, written in 1999. Now they use just the fortified POSIX API, e.g. for <code>strncpy_s</code> <code>strncpy_chk</code> and <code>__strncpy_chk2</code> with known src size.</p>
<p>See <a href="https://en.wikipedia.org/wiki/Bionic_(software)#Fortify_source">Wikipedia: Bionic Fortify_source</a>, and their blog post <a href="https://android-developers.googleblog.com/2017/04/fortify-in-android.html">FORTIFY in Android</a>.</p>
<p>Basically they use a <code>__bos()</code> or <code>__builtin_object_size</code> macro which is a better <code>sizeof</code> and expands to the size of the compile-time pointer when the size of the buffer is known at compile-time. They also try to use the <code>alloc_size</code> extension which looks at a malloc'ed pointer into the previous word for its size. So there's no secure API, just the normal POSIX and glibc API with compile-time <code>_chk</code> checks as in glibc with FORTIFY. Just a bit better than glibc.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Huawei securec</h2>
<p>This is similar to the secure Android and slibc variant, written in C and it is a proper secure libc. Their license is restrictive though: Copyright @ Huawei Technologies Co., Ltd. 1998-2014. All rights reserved.</p>
<p>Available at <a href="https://github.com/UVP-Tools/UVP-Tools/tree/master/uvp-monitor/securec">https://github.com/UVP-Tools/UVP-Tools/tree/master/uvp-monitor/securec</a> There are other variants under the GPL-2 and Apache 2.0 on github (e.g. wangguitao/intelligent-protector)</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Open Watcom 1.5</h2>
<p>Tested by <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1967.htm#alternatives">http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1967.htm#alternatives</a> It sets the <code>__STDC_LIB_EXT1__</code> macro to <code>200509L</code> and can be considered a nearly conforming implementation.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
slibc</h2>
<p>"Slibc is a complete, open source implementation of Annex K designed
to be used with GNU C library typically distributed with Linux. The
implementation claims to be complete and to fully conform to C11. An
inspection of the implementation reveals that it is quite inefficient
and thus unsuitable for production use without considerable
changes. It does provide a good referefence implementation of the
library. A proposal to incorporate slibc into the GNU C library was
submitted in 2012 to the GNU C library community and rejected."</p><ul>
<li><a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1967.htm#alternatives">http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1967.htm#alternatives</a></li>
</ul>
<p>Available at <a href="https://code.google.com/archive/p/slibc/">https://code.google.com/archive/p/slibc/</a></p>
<h1><a class="anchor" id="autotoc_md18"></a>
Other caveats</h1>
<h2><a class="anchor" id="autotoc_md19"></a>
glibc</h2>
<ul>
<li>SEGV with <code>freopen(NULL, "rb", stdin)</code> with asan on some systems, calling an invalid <code>strlen()</code> on NULL.</li>
<li><p class="startli">quirky declaration of various standards, which conflict with each other.</p>
<p class="startli">glibc needs the correct standard to include some extensions when we declare the standard by ourselves. e.g. clang-4.0 -std=c99 misses several reentrant versions. when defining <code>_XOPEN_SOURCE 700</code> to define <code>strnlen</code> and the reentrant time versions, we need also <code>__STDC_WANT_LIB_EXT1__ 1</code> for <code>errno_t</code>, and this would break several other older struct members, such as <code>tm_gmtoff</code></p>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md20"></a>
newlib</h2>
<ul>
<li><code>vswscanf</code> is broken with a format string containing <code>L"%%n"</code></li>
<li>The following multibyte API's are missing, and can be defined like this:</li>
</ul>
<div class="fragment"><div class="line">mbstate_t st;</div>
<div class="line">#define wctomb(dest, wc) wcrtomb((dest), (wc), &amp;st)</div>
<div class="line">#define wcstombs(dest, src, len) wcsrtombs((dest), &amp;(src), (len), &amp;st)</div>
<div class="line">#define mbstowcs(dest, src, len) mbsrtowcs((dest), &amp;(src), (len), &amp;st)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md21"></a>
FreeBSD libc</h2>
<ul>
<li><code>vswscanf</code> is broken with a format string containing <code>L"%%n"</code></li>
<li><code>mbstowcs</code> is broken with &lsquo;(NULL, &rsquo;\0')`</li>
</ul>
<h2><a class="anchor" id="autotoc_md22"></a>
musl</h2>
<ul>
<li><code>wmemcmp</code> returns not <code>-1</code>, <code>0</code> or <code>1</code> but the full ptr diff.</li>
<li><code>mbtowc</code> and <code>wctomb</code> accept and convert illegal 4 byte characters in the ASCII locale to surrogate pairs, as it would be unicode. e.g. it converts <code>\xa0</code> to <code>\xdfa0</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md23"></a>
wine</h2>
<p>As of wine-2.0.4 its libc has several more errors than the msvcrt sec_api:</p>
<ul>
<li><code>asctime_s</code> with <code>tm-&gt;mday=0</code> returns not <code>EINVAL</code> but <code>0</code>.</li>
<li><code><a class="el" href="../../d8/dff/safe__str__lib_8h.html#a5f9c5e49a21cdf8853bb04a40b8c55ad" title="The wcsncat_s function appends a copy of the wide string pointed to by src (including the terminating...">wcsncat_s(dest, dmax, src, 0)</a></code> returns not <code>EINVAL</code> but <code>0</code>.</li>
<li><code><a class="el" href="../../d8/dff/safe__str__lib_8h.html#a5f9c5e49a21cdf8853bb04a40b8c55ad" title="The wcsncat_s function appends a copy of the wide string pointed to by src (including the terminating...">wcsncat_s(NULL, 0, src, 0)</a>;</code> returns not <code>0</code> but <code>EINVAL</code>.</li>
<li>more <code>wcsncat_s</code>: ESUNTERM and ESOVRLP do not clear dest</li>
<li><code>wcsrtombs_s(&amp;ind, dest, 0, &amp;cs, 0, &amp;ps)</code> returns not <code>EINVAL</code> but <code>0</code>, with <code>ind</code> kept at <code>0</code>.</li>
</ul>
<hr  />
<p>It's now 10 years after the secure libc extensions were designed, C11 adopted them, and still almost nobody implements them. Only for compile-time known sizes the FORTIFY <code>_chk</code> extension secures against overflows, but not against dynamically allocated buffers. This library was written 2008 under the MIT license, thanks Cisco.</p>
<p>Reini Urban 2018 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<hr class="footer"/><address class="footer"><small>
Generated for Safe C Library 3.9 3.9
by <a href="http://www.doxygen.org/index.html">doxygen</a>
</small></address></body></html>
